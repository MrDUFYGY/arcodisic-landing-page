<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Arcodisic - Administrador de Contenido</title>

    <style>
      :root {
        color-scheme: light dark;
      }
      .identity-alert {
        position: fixed;
        top: 16px;
        right: 16px;
        padding: 16px 20px;
        border-radius: 12px;
        background: rgba(220, 38, 38, 0.95);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        box-shadow: 0 20px 45px rgba(220, 38, 38, 0.3);
        max-width: 320px;
        display: none;
        z-index: 9999;
      }
      .identity-alert.show {
        display: block;
      }
      .identity-alert strong {
        display: block;
        font-size: 16px;
        margin-bottom: 6px;
      }
      .identity-alert button {
        margin-top: 12px;
        border: none;
        background: rgba(255, 255, 255, 0.25);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .identity-alert button:hover {
        background: rgba(255, 255, 255, 0.35);
      }
    </style>

    <!-- Netlify Identity Widget (solo en producción) -->
    <script>
      (function() {
        function showAlert(message) {
          var alertEl = document.querySelector('.identity-alert');
          if (!alertEl) return;

          alertEl.querySelector('span').textContent = message;
          alertEl.classList.add('show');

          var closeBtn = alertEl.querySelector('button');
          if (closeBtn) {
            closeBtn.onclick = function() {
              alertEl.classList.remove('show');
            };
          }
        }

        function initializeIdentity() {
          var identity = window.netlifyIdentity;
          if (!identity) {
            showAlert('No pudimos cargar Netlify Identity. Revisa tu conexión.');
            return;
          }

          identity.on('init', function(user) {
            if (!user) {
              identity.open('login');
            }
          });

          identity.on('login', function() {
            document.location.href = '/admin/';
          });

          identity.on('error', function(err) {
            console.error('Identity error:', err);
            showAlert(err && err.message ? err.message : 'Ocurrió un error con Netlify Identity.');
          });
        }

        // Solo cargar Netlify Identity en producción
        var isProduction = window.location.hostname !== 'localhost' && 
                            window.location.hostname !== '127.0.0.1';

        if (isProduction) {
          if (window.netlifyIdentity) {
            initializeIdentity();
          } else {
            var script = document.createElement('script');
            script.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
            script.async = true;
            script.onload = initializeIdentity;
            script.onerror = function() {
              showAlert('No se pudo cargar Netlify Identity. Intenta refrescar la página.');
            };
            document.head.appendChild(script);
          }
        }
      })();
    </script>
  </head>
  <body>
    <div class="identity-alert" role="alert" aria-live="assertive">
      <strong>⚠️ Error de autenticación</strong>
      <span></span>
      <button type="button">Cerrar</button>
    </div>

    <!-- DecapCMS -->
    <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>

    <script>
      (function() {
        if (!window.CMS) {
          console.error('Decap CMS no está disponible.');
          return;
        }

        CMS.init();

        CMS.registerPreviewStyle('/styles/cms.css');
        CMS.registerEventListener({
          name: 'preSave',
          handler: function(event) {
            console.log('Guardando entrada:', event.entry.get('title'));
          }
        });

        window.addEventListener('load', function() {
          requestAnimationFrame(function() {
            var logo = document.querySelector('.nc-githubAuthenticationPage-logo img');
            if (logo) {
              logo.src = '/logo.svg';
              logo.alt = 'Arcodisic';
              logo.style.maxWidth = '180px';
            }

            var title = document.querySelector('.nc-githubAuthenticationPage h1');
            if (title) {
              title.textContent = 'Arcodisic CMS';
            }

            var subtitle = document.querySelector('.nc-githubAuthenticationPage h2');
            if (subtitle) {
              subtitle.textContent = 'Inicia sesión para administrar el contenido';
            }
          });
        });
      })();
    </script>
  </body>
</html>
