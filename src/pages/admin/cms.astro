---
// PÃ¡gina principal del CMS - DecapCMS
// Esta es la pÃ¡gina real donde se carga el editor de contenido
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Arcodisic - Editor CMS</title>
    
    <!-- Netlify Identity Widget: Solo en producciÃ³n -->
    <script is:inline>
      (function() {
        // Detectar si estamos en producciÃ³n
        var isProduction = window.location.hostname !== 'localhost' && 
                          window.location.hostname !== '127.0.0.1';
        
        if (!isProduction) {
          console.log('ğŸ”§ Modo LOCAL: Netlify Identity deshabilitado');
          console.log('ğŸ“ AsegÃºrate de ejecutar: npm run cms:local');
          return;
        }

        console.log('ğŸŒ Modo PRODUCCIÃ“N: Cargando Netlify Identity...');

        // FunciÃ³n para inicializar Netlify Identity
        function initNetlifyIdentity() {
          var identity = window.netlifyIdentity;
          
          if (!identity) {
            console.error('âŒ Netlify Identity no estÃ¡ disponible');
            return;
          }

          console.log('âœ… Netlify Identity cargado');

          // Evento: Usuario inicializado
          identity.on('init', function(user) {
            console.log('ğŸ”„ Identity init:', user ? 'âœ… Usuario autenticado' : 'âŒ Sin usuario');
            
            if (!user) {
              // Si no hay usuario, abrir modal de login
              console.log('ğŸ”“ Abriendo modal de login...');
              identity.open('login');
            } else {
              console.log('ğŸ‘¤ Usuario:', user.email);
            }
          });

          // Evento: Usuario hizo login
          identity.on('login', function(user) {
            console.log('âœ… Login exitoso:', user.email);
            // No redirigir, dejar que DecapCMS se cargue
          });

          // Evento: Usuario hizo logout
          identity.on('logout', function() {
            console.log('ğŸ‘‹ Logout - Redirigiendo...');
            window.location.href = '/admin';
          });

          // Evento: Error
          identity.on('error', function(err) {
            console.error('âŒ Identity Error:', err);
          });
        }

        // Cargar el script de Netlify Identity si estamos en producciÃ³n
        if (isProduction) {
          if (window.netlifyIdentity) {
            // Ya estÃ¡ cargado (posiblemente desde otro script)
            initNetlifyIdentity();
          } else {
            // Cargar dinÃ¡micamente
            var script = document.createElement('script');
            script.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
            script.async = true;
            script.onload = function() {
              console.log('ğŸ“¦ Script de Netlify Identity cargado');
              initNetlifyIdentity();
            };
            script.onerror = function() {
              console.error('âŒ Error al cargar Netlify Identity');
            };
            document.head.appendChild(script);
          }
        }
      })();
    </script>
  </head>
  <body>
    <!-- DecapCMS: Editor de contenido -->
    <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
    
    <script is:inline>
      console.log('ğŸ“ DecapCMS cargado');
      console.log('ğŸ“‚ ConfiguraciÃ³n: /admin/config.yml');
    </script>
  </body>
</html>
